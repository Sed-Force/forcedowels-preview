<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Your Cart — Force Dowels™</title>
  <meta name="description" content="Review your Force Dowels cart and proceed to checkout.">
  <link rel="icon" href="/favicon.ico" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css?v=32">

  <style>
    /* Scoped cart styles to avoid clashes */
    .cart-wrap{max-width:980px;margin:32px auto;padding:0 16px;}
    .cart-card{background:#0b0b0c;border:1px solid #1e1f23;border-radius:16px;padding:16px;}
    .cart-h{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .cart-h h1{font-size:20px;font-weight:800;margin:0}
    .cart-h .muted{opacity:.75;font-size:14px}

    .cart-tbl{width:100%;border-collapse:separate;border-spacing:0 10px;}
    .cart-row{display:grid;grid-template-columns:1.2fr .9fr .9fr .2fr;gap:12px;align-items:center;background:#111214;border:1px solid #1e1f23;border-radius:12px;padding:12px}
    .cart-title{font-weight:700}
    .cart-meta{opacity:.75;font-size:14px;margin-top:4px}
    .qty{display:inline-flex;align-items:center;gap:8px}
    .qty input{width:88px;background:#0b0b0c;border:1px solid #2a2b31;color:#fff;border-radius:10px;padding:8px 10px;text-align:center}
    .qty .step{width:34px;height:34px;border-radius:9px;border:1px solid #2a2b31;background:#121316;color:#fff}
    .cart-line-total{font-weight:800;text-align:right}
    .cart-remove{width:34px;height:34px;border-radius:9px;border:1px solid #2a2b31;background:#121316;color:#fff}

    .cart-foot{display:flex;justify-content:flex-end;margin-top:16px}
    .sum{min-width:340px;background:#0b0b0c;border:1px solid #1e1f23;border-radius:12px;padding:14px}
    .sum-row{display:flex;justify-content:space-between;margin:6px 0}
    .sum strong{font-weight:800}
    .sum .muted{opacity:.75;font-size:14px;margin:-2px 0 8px}
    .btn-primary{display:inline-flex;justify-content:center;align-items:center;width:100%;height:44px;margin-top:10px;border-radius:10px;
      background:#ff7a00;color:#0b0b0c;font-weight:800;border:none}

    .empty{display:none;text-align:center;padding:36px 16px;border:1px dashed #2a2b31;border-radius:16px}
    .empty h3{margin:0 0 6px}
    .empty .btn{display:inline-flex;align-items:center;gap:8px;margin-top:12px}

    /* make header cart badge visible if present */
    .badge{display:inline-block;min-width:18px;height:18px;line-height:18px;padding:0 6px;border-radius:10px;background:#ff7a00;color:#0b0b0c;font-weight:800;margin-left:6px}
  </style>
</head>
<body>

<!-- Header (keep your existing header; just ensure /cart.html link) -->
<header class="site-header">
  <div class="container header-inner">
    <a class="brand" href="/" aria-label="Force Dowel Company">
      <img src="/images/force-dowel-logo.jpg" alt="Force Dowel Company logo" />
    </a>
    <nav class="nav" aria-label="Primary">
      <a href="/">Home</a>
      <a href="/order.html">Order</a>
      <a href="/videos.html">Videos</a>
      <a href="/faq.html">FAQ</a>
      <div class="nav-dropdown">
        <button class="nav-dropbtn" type="button" aria-haspopup="true" aria-expanded="false">
          <span class="nav-drop-label">Distributors</span><span class="nav-caret">▾</span>
        </button>
        <div class="nav-dropmenu" role="menu">
          <a href="/distributors.html" role="menuitem">Find a Distributor</a>
          <a href="/distributor-application.html" role="menuitem">Become a Distributor</a>
        </div>
      </div>
      <a href="/contact.html" class="btn btn--accent">Contact</a>
    </nav>
    <div class="header-actions">
      <a href="/cart.html" class="btn btn--ghost btn--invert" id="btn-cart" aria-label="Shopping cart"
         onclick="window.location='/cart.html';return false;">
        <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M7 18a2 2 0 1 0 0 4a2 2 0 0 0 0-4m10 0a2 2 0 1 0 0 4a2 2 0 0 0 0-4M6.2 6l.3 2h12.3a1 1 0 0 1 1 1l-1.2 6a2 2 0 0 1-2 1.6H8.7a2 2 0 0 1-2-1.7L5.3 5H3V3h3a1 1 0 0 1 1 .9L7.2 6Z"/></svg>
        <span class="hide-sm">Cart</span>
        <span id="cart-count" class="badge"></span>
      </a>
      <div class="auth-buttons">
        <button class="btn btn--ghost btn--invert" type="button">Login</button>
        <button class="btn btn--accent" type="button">Sign Up</button>
      </div>
    </div>
  </div>
</header>

<main id="content">
  <section class="cart-wrap">
    <div class="cart-h">
      <h1>Your Cart</h1>
      <div class="muted">Review items & proceed to checkout</div>
    </div>

    <div class="empty" id="cart-empty">
      <h3>Your cart is empty</h3>
      <p class="muted">Add Force Dowels on the Order page and return here to checkout.</p>
      <a class="btn btn--accent" href="/order.html">Start Order</a>
    </div>

    <div class="cart-card" id="cart-card" style="display:none;">
      <div class="cart-tbl" id="cart-items"></div>

      <div class="cart-foot">
        <div class="sum">
          <div class="sum-row"><span>Subtotal</span><strong id="cart-subtotal">$0.00</strong></div>
          <div class="muted">Shipping & taxes calculated at checkout.</div>
          <button class="btn-primary" id="btn-checkout" type="button">Proceed to Checkout</button>
        </div>
      </div>
    </div>
  </section>
</main>

<footer class="site-footer">
  <div class="container footer-main">
    <section class="footer-sec footer-sec--brand">
      <a href="/" aria-label="Force Dowels home" class="footer-brand-wrap">
        <img src="/images/force-dowel-logo.jpg?v=4" alt="Force Dowels logo" class="footer-logo" />
      </a>
      <p class="footer-tagline">Revolutionary cabinetry fasteners that deliver faster assembly, stronger connections, and flawless finishes.</p>
    </section>
    <section class="footer-sec">
      <h4>Quick Links</h4>
      <ul class="footer-list">
        <li><a href="/">Home</a></li>
        <li><a href="/order.html">Order Now</a></li>
        <li><a href="/videos.html">Product Videos</a></li>
        <li><a href="/distributors.html">Find a Distributor</a></li>
        <li><a href="/distributor-application.html">Become a Distributor</a></li>
      </ul>
    </section>
    <section class="footer-sec">
      <h4>Contact Us</h4>
      <ul class="footer-list">
        <li>(480)-581-7145</li>
        <li>Hours: Mon–Thurs 7:30AM–4:30PM; Friday 7:30AM–11:30AM</li>
        <li><a href="mailto:info@forcedowels.com">info@forcedowels.com</a></li>
        <li>4455 E Nunneley Rd, Ste 103<br>Gilbert, AZ 85296</li>
      </ul>
    </section>
    <section class="footer-sec">
      <h4>Stay Updated</h4>
      <form class="footer-form" onsubmit="return false;">
        <label class="sr-only" for="newsletter-email">Enter your email</label>
        <input id="newsletter-email" type="email" placeholder="Enter your email" required>
        <button type="submit" class="btn btn--accent">Subscribe</button>
      </form>
    </section>
  </div>
  <div class="footer-separator"></div>
  <div class="container footer-bottom">
    <div class="footer-bottom-left">
      <p>© <span id="year"></span> Force Dowels. All rights reserved.</p>
    </div>
    <nav class="footer-bottom-right">
      <a href="/privacy.html">Privacy Policy</a>
      <a href="/terms.html">Terms of Service</a>
    </nav>
  </div>
</footer>

<script>
  // Footer year
  (function(){ var y=document.getElementById('year'); if(y) y.textContent=new Date().getFullYear();})();

  // -------- CART LOGIC (self-contained) --------
  const FD_CART_KEY = 'fd_cart';

  const TIERS = [
    { min: 5000,   max: 20000,   ppu: 0.0720 },
    { min: 20001,  max: 160000,  ppu: 0.0675 },
    { min: 160001, max: 960000,  ppu: 0.0630 },
  ];
  function ppuFor(q){ q=+q||0; for(const t of TIERS){ if(q>=t.min&&q<=t.max) return t.ppu;} return q>960000?TIERS[2].ppu:TIERS[0].ppu; }
  function $fmt(n){ return '$'+((+n||0).toFixed(2)); }
  function $fmt4(n){ return '$'+((+n||0).toFixed(4)); }

  function getCart(){
    try{ const raw=localStorage.getItem(FD_CART_KEY); if(!raw) return []; const p=JSON.parse(raw); return Array.isArray(p)?p:[]; }
    catch{ localStorage.removeItem(FD_CART_KEY); return []; }
  }
  function saveCart(items){
    localStorage.setItem(FD_CART_KEY, JSON.stringify(items||[]));
    updateBadge();
  }
  function updateBadge(){
    const el=document.getElementById('cart-count');
    if(!el) return;
    const items=getCart();
    const total=items.reduce((s,i)=>s+(+i.qty||0),0);
    el.textContent = total>0 ? String(total) : '';
  }

  function persistFromRows(rows){
    const out=[];
    rows.forEach(r=>{
      if(r.type==='bulk'){
        if(r.qty>0) out.push({type:'bulk', sku:'force-bulk', name:'Force Dowels — Bulk', qty:r.qty});
      }else if(r.type==='kit'){
        if(r.qty>0) out.push({type:'kit', sku:r.sku||'FD-KIT-300', name:r.name||'Force Dowels Kit — 300 units', qty:r.qty});
      }
    });
    saveCart(out);
  }

  function render(){
    updateBadge();
    const list = document.getElementById('cart-items');
    const subtotalEl = document.getElementById('cart-subtotal');
    const empty = document.getElementById('cart-empty');
    const card = document.getElementById('cart-card');

    if(!list||!subtotalEl||!empty||!card) return;

    const items = getCart();
    // combine all bulk
    let bulkQty=0; const kits=[];
    for(const it of items){
      if(it.type==='bulk') bulkQty += (+it.qty||0);
      else if(it.type==='kit') kits.push({...it, qty:+it.qty||1});
    }

    const rows=[];
    if(bulkQty>0){
      rows.push({type:'bulk', qty:bulkQty, unitPrice:ppuFor(bulkQty)});
    }
    for(const k of kits){
      rows.push({type:'kit', qty:k.qty, unitPrice:36.00, sku:k.sku, name:k.name});
    }

    if(rows.length===0){
      empty.style.display='block';
      card.style.display='none';
      subtotalEl.textContent = '$0.00';
      return;
    }
    empty.style.display='none';
    card.style.display='block';

    list.innerHTML='';
    let subtotal=0;

    rows.forEach((r,idx)=>{
      const lineTotal = r.qty * r.unitPrice;
      subtotal += lineTotal;

      const row = document.createElement('div');
      row.className='cart-row';
      row.innerHTML = `
        <div>
          <div class="cart-title">${r.type==='bulk' ? 'Force Dowels — Bulk' : 'Force Dowels Kit — 300 units'}</div>
          <div class="cart-meta">
            ${r.type==='bulk'
              ? `${r.qty.toLocaleString()} units @ ${$fmt4(r.unitPrice)}/unit`
              : `1 kit @ $36.00`
            }
          </div>
        </div>

        <div class="qty">
          <button class="step" data-idx="${idx}" data-act="dec" aria-label="Decrease">–</button>
          <input class="qty-input" data-idx="${idx}" type="number" min="1" step="${r.type==='bulk'?5000:1}" value="${r.qty}">
          <button class="step" data-idx="${idx}" data-act="inc" aria-label="Increase">+</button>
        </div>

        <div class="cart-line-total">${$fmt(lineTotal)}</div>
        <button class="cart-remove" data-idx="${idx}" aria-label="Remove">✕</button>
      `;
      list.appendChild(row);
    });

    subtotalEl.textContent = $fmt(subtotal);

    // wire qty +/-
    list.querySelectorAll('.step').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const idx=+btn.dataset.idx; const act=btn.dataset.act;
        const r=rows[idx];
        if(r.type==='bulk'){
          r.qty = Math.max(5000, Math.min(960000, r.qty + (act==='inc'?5000:-5000)));
          r.unitPrice = ppuFor(r.qty);
        }else{
          r.qty = Math.max(1, r.qty + (act==='inc'?1:-1));
        }
        persistFromRows(rows);
        render();
      });
    });
    list.querySelectorAll('.qty-input').forEach(inp=>{
      inp.addEventListener('change',()=>{
        const idx=+inp.dataset.idx; const r=rows[idx];
        let v=+inp.value||1;
        if(r.type==='bulk'){
          v = Math.max(5000, Math.min(960000, Math.round(v/5000)*5000));
          r.unitPrice = ppuFor(v);
        }else{
          v = Math.max(1, Math.round(v));
        }
        r.qty=v;
        persistFromRows(rows);
        render();
      });
    });
    list.querySelectorAll('.cart-remove').forEach(btn=>{
      btn.addEventListener('click',()=>{
        rows.splice(+btn.dataset.idx,1);
        persistFromRows(rows);
        render();
      });
    });

    // checkout
    const btn = document.getElementById('btn-checkout');
    btn.onclick = async ()=>{
      try{
        btn.disabled=true; btn.textContent='Redirecting…';
        const payload = rows.map(r=>({ type:r.type, sku:r.sku, qty:r.qty }));
        const res = await fetch('/api/checkout',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({items:payload})});
        if(!res.ok) throw new Error('Checkout failed');
        const data = await res.json();
        if(data?.url){ window.location=data.url; return; }
        throw new Error('No redirect URL');
      }catch(e){
        alert('Sorry—checkout could not start. Please try again.');
        btn.disabled=false; btn.textContent='Proceed to Checkout';
      }
    };
  }

  document.addEventListener('DOMContentLoaded',()=>{
    updateBadge();
    render();
  });

  // ---- Optional quick seed for testing (run once in DevTools) ----
  // localStorage.setItem('fd_cart', JSON.stringify([
  //   {type:'bulk', qty:5000},
  //   {type:'kit',  sku:'FD-KIT-300', qty:1}
  // ]));
</script>
</body>
</html>

